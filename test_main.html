<!doctype html>
<html lang="us">
<head>
<meta charset="utf-8">
<title>DBMod - ER-Diagram Case Tool 4 U</title>
<link href="css/jquery-ui-1.10.3.custom.css" rel="stylesheet">
<link href="css/dbmod.css" rel="stylesheet">
<link href="css/contextMenu.css" rel="stylesheet">
<script src="js/jquery-1.9.1.js"></script>
<script src="TableManager.js"></script>
<script src="algo_simple.js"></script>
<script src="js/jquery-ui-1.10.3.custom.js"></script>
<script src="js/contextMenu.js"></script>
<script src="js/contextMenu.min.js"></script>
<script type="text/javascript" src="js/jquery.jsPlumb-1.5.3.js "></script>
<script type="text/javascript" src="js/jsPlumbSetup.js "></script>
<script>
$(function() {
    /*
    TODO:
        1. configure multiple connections between same ent. and same REGULAR rel.
        2. configure edit and delete functionalities for context menus
        3. universal context menus
        4. hiding of the connection drag images when inactive
        5. global variable setting for context menus
        6. universal name indepedent ids for attributes and entities
        7. set of all relationships and entities
        8. popup for all the confirms 
    */
    // Storage variable
    var allEntities = [];
    var allRelationships = [];
    var defaultConnectionPaintStyle = {lineWidth:2,strokeStyle:'rgb(0,0,0)'},
        defaultOnHoverConnectionPaintStyle = {lineWidth:5,strokeStyle:'rgb(143,214,0)'}
    var defaultEndpointProperties = { src : "img/littledot.png",
                                                    cssClass : "endpoint-entity" };
    var current_component_div = "";

    //context menu for entity and relationship
    var contextMenuSettings={
        method:'menu',
        option:{
            afterOpen : function (data,e) {
                //records the latest context menu's linked component
                current_component_div = data.trigger.context.id;
            },
            triggerOn: 'click',
            displayAround: 'cursor',
            mouseClick: 'right',
            verAdjust: 0,
            horAdjust: 0,
            top:'auto',
            left:'auto',
            sizeStyle:'auto',
            position: 'auto',
    }};
    var contextMenuUniSettings={
        method:'menu',
        option:{
            onClose : function (data,e) {
                //records the latest context menu's linked component
                $("#canvas").contextMenu('destroy');
            },
            triggerOn: 'click',
            displayAround: 'cursor',
            mouseClick: 'right',
            verAdjust: 0,
            horAdjust: 0,
            top:'auto',
            left:'auto',
            sizeStyle:'auto',
            position: 'auto',
    }};
    //functions are placeholders for now
    var commonMenu = [{
        name: 'Edit Name',
        fun: function () {
            alert('prompt for new name')
        }}, {
        name: 'Delete',
        fun: function (data,e) {
            console.log(data);
        }}];
    var attributeMenu = [{
        name: 'Edit Name',
        fun: function () {
            alert('prompt for new name')
        }}, {
   name: 'Toggle Identifying Attribute',
        fun: function () {
            alert('toggle id key')
        }}, {
   name: 'Delete',
        fun: function () {
            alert('delete')
        }}];
    var uniMenu = [{
        name: 'Add Entity',
        fun: function () {
            alert('prompt for new name')
        }}, {
        name: 'Add Relationship',
        fun: function (data,e) {
            console.log(data);
        }}, {
        name: 'Add Attribute',
        fun: function (data,e) {
            console.log(data);
        }}];
    /*
        Counters of relationships with same name
            1. ISA-counter
            2. Union-OP-counter
            3. Intersection-OP-counter
            4. 
     */
    var relationshipCounter = 0,
        attributeCounter = 0;

    function getConnectionProperty(source, target, perimeterType) {
        var newProperty = {
                        source: source,
                        target: target,
                        paintStyle:defaultConnectionPaintStyle,
                        hoverPaintStyle:defaultOnHoverConnectionPaintStyle,
                        anchor: ["Perimeter", { shape : perimeterType} ],
                        endpoint : "Dot",
                        endpointStyle : { radius : 1}
                    };

        return newProperty;
    }

    function doesConnectionExist(source, target) {
        var totalNumberOfConnections = jsPlumb.getConnections({ source : source, target : target}) +
                                       jsPlumb.getConnections({ source : target, target : source});
        return (totalNumberOfConnections.length > 0);
    }

    function doesConnectionHaveParameterWithValue (connectionObject, parameter, expectedValue) {
        return (connectionObject.getParameters()[parameter] == expectedValue);
    }
    //For functions where only parent connection can exist
    function hasParentConnection(object) {
        var currentConnections;

        //First check all connections where "object" is the source

        currentConnections = jsPlumb.getConnections({source : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isParentConnection",true)) {
                return true;
            }
        };

        //Next check all connections where "object" is the target

        currentConnections = jsPlumb.getConnections({target : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isParentConnection",true)) {
                return true;
            }
        };

        return false;
    }

    //For functions where only normal entity connection can exist
    function hasNormalEntityConnection(object) {
        var currentConnections;

        //First check all connections where "object" is the source

        currentConnections = jsPlumb.getConnections({source : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",true)) {
                return true;
            }
        };

        //Next check all connections where "object" is the target

        currentConnections = jsPlumb.getConnections({target : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",true)) {
                return true;
            }
        };

        return false;
    }

    //For functions where only normal entity connection can exist
    function hasWeakEntityConnection(object) {
        var currentConnections;

        //First check all connections where "object" is the source

        currentConnections = jsPlumb.getConnections({source : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",false)) {
                return true;
            }
        };

        //Next check all connections where "object" is the target

        currentConnections = jsPlumb.getConnections({target : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",false)) {
                return true;
            }
        };

        return false;
    }

    jsPlumb.Defaults.Container = $("#canvas");
    jsPlumb.Defaults.Connector = "Straight";
    jsPlumb.Defaults.PaintStyle = defaultConnectionPaintStyle;
    
    // Functions to check inputs
    function checkInputVal(val,array){
        if(val == "") {
            return 0;
        } else {
            return ($.inArray(val,array));
        }
    }

//Add connection listener
jsPlumb.bind('beforeDrop', function (info) {
    /*
    Structure of "info" object
        {
          connection         :     the new Connection.  you can register listeners on this etc.
          sourceId         :    id of the source element in the Connection
          targetId        :    id of the target element in the Connection
          source        :    the source element in the Connection
          target        :    the target element in the Connection
          sourceEndpoint    :    the source Endpoint in the Connection
          targetEndpoint    :    the targetEndpoint in the Connection
        }
    */
    //alert(JSON.stringify(info.sourceId));
    var QsourceObj = $("#"+info.sourceId),
        QtargetObj = $("#"+info.targetId),
        newConnection = null;

    if(!hasReachedConnectionLimit(QsourceObj) && !hasReachedConnectionLimit(QtargetObj) ) {
        //TODO : enable connection between an attribute and relationship
        //TODO : enable recursive relationship between entity and attribute

        if( info.sourceId != info.targetId) {
            if(!doesConnectionExist(QsourceObj,QtargetObj)) {
                if(isEntityType(QsourceObj) && isEntityType(QtargetObj)) {
                    alert("Cannot directly join 2 entity types");
                } else if( (isRelationshipType(QsourceObj) && isEntityType(QtargetObj)) ||
                            (isRelationshipType(QtargetObj) && isEntityType(QsourceObj))) {
                    
                    var entityObj = isRelationshipType(QsourceObj) ? QtargetObj : QsourceObj,
                        relationShipObj = isRelationshipType(QsourceObj) ? QsourceObj : QtargetObj;

                    if(isRegularRelationshipType(relationShipObj)) {
                        var labelOverlay = null,
                            connectionProperty = null

                        $("#attr0-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var labelVal = $("#attr0-dialog > input:checked").val();

                                    labelOverlay = [ "Label", { label : labelVal, location : 0.5, cssClass : "cardinality"}];
                            
                                    connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond");
                    
                                    connectionProperty.overlays = [ labelOverlay];
                                    newConnection = jsPlumb.connect(connectionProperty);
                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }
                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });
                        

                    } else if (isSingleParentRelationshipType(relationShipObj)) {
                        /*
                            Conditional checks for relationships where the parent is restricted to 1 entity
                        */
                        var overlayConfig = null,
                            connectionProperty = null,
                            isTargetEntity = isEntityType(QtargetObj),
                            isParentConnection = false;

                        $("#attr2-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var selectedOption = $("#attr2-dialog > input:checked").val();

                                    isParentConnection = (selectedOption == "0") ? true : false;

                                    if (!hasParentConnection(relationShipObj) && isParentConnection) {
                                        overlayConfig = [["Arrow", { width : 10, length: 10, location : 1, direction: 1}]];
                                    } else if(hasParentConnection(relationShipObj) && isParentConnection) {
                                        alert("Cannot have more than 1 parent connection!!");
                                        return false;
                                    }

                                    connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond");

                                    if(overlayConfig != null) {
                                        connectionProperty.overlays = overlayConfig;
                                    }

                                    connectionProperty.parameters = {};
                                    connectionProperty.parameters.isParentConnection = isParentConnection;

                                    newConnection = jsPlumb.connect(connectionProperty);

                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }

                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });

                    } else if (isNormalWeakRelationshipType(relationShipObj)) {
                        
                        var isNormalEntityConnection = (isNormalEntityType(QsourceObj)||isNormalEntityType(QtargetObj));
                            overlayConfig = null,
                            isParentConnection = confirm("Press OK if parent connection, CANCEL otherwise");

                        $("#attr2-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var selectedOption = $("#attr2-dialog > input:checked").val();

                                    isParentConnection = (selectedOption == "0") ? true : false;

                                    if(isParentConnection) {
                                        if (hasParentConnection(relationShipObj)) {
                                            alert("Cannot have more than 1 parent connections");
                                            return false;
                                        } else {
                                            //no overlays for parent connection
                                        }
                                    } else {
                                        if (isNormalEntityConnection ) {
                                            alert("Cannot create non-parent connection with normal entity.");
                                            return false;
                                        } else if ((getConnectionCount(relationShipObj) > 0) && !hasParentConnection(relationShipObj) ) {
                                            alert("Cannot have 2 child connections.")
                                            return false;
                                        } else {
                                            overlayConfig = [["Arrow", { width : 10, length: 10, location : 1, direction: 1}]];
                                        }

                                    }

                                    connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond");

                                    if(overlayConfig != null) {
                                        connectionProperty.overlays = overlayConfig;
                                    }

                                    connectionProperty.parameters = {};
                                    connectionProperty.parameters.isNormalEntityConnection = isNormalEntityConnection;
                                    connectionProperty.parameters.isParentConnection = isParentConnection;

                                    newConnection = jsPlumb.connect(connectionProperty);

                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }

                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });  
                    }
                 } else if( ((isEntityType(QsourceObj)||isRegularRelationshipType(QsourceObj)) && isAttributeType(QtargetObj)) ||
                           ((isEntityType(QtargetObj)||isRegularRelationshipType(QtargetObj)) && isAttributeType(QsourceObj))) {
                    
                    var attributeEndpoint, overlayConfig,
                        attribObj = isAttributeType(QtargetObj) ? QtargetObj : QsourceObj,
                        nonAttribObj= isAttributeType(QtargetObj) ? QsourceObj : QtargetObj,
                        toAddLater = null,
                        connectionProperty = null;

                    //var arrowDirection, arrowLocation;
                    var arrowWidth = 10,
                        arrowLength = 10;


                    $("#attr1-dialog").dialog({
                        resizable : false,
                        modal : true,
                        buttons : {
                            "OK" : function () {
                                var selectedOption = $("#attr1-dialog > input:checked").val();

                                switch(selectedOption) {
                                    case "0":
                                        overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                    ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
                                    break;
                                    case "1":
                                        overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                    ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}],
                                    ["Arrow", { width : arrowWidth, length: arrowLength, location : 11, direction: -1}]];
                                    break;
                                    case "2":
                                        overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
                                    break;
                                    case "3":
                                        overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}],
                                    ["Arrow", { width : arrowWidth, length: arrowLength, location : 11, direction: -1}]];
                                    break;
                                }

                                connectionProperty = getConnectionProperty(attribObj,nonAttribObj,"Ellipse");
                                attributeEndpoint = jsPlumb.selectEndpoints({ source: attribObj});
                                connectionProperty.overlays = overlayConfig;
                                newConnection = jsPlumb.connect(connectionProperty);
                                attributeEndpoint.setEnabled(false);

                                if(newConnection !== null) {
                                     newConnection.bind('click', function (connection) {
                                        var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                        if(deleteConnection) {
                                            if(isAttributeType(fetchParentOfEndpoint(connection.endpoints[0])) ||(isAttributeType(fetchParentOfEndpoint(connection.endpoints[1])))) {
                                                attributeEndpoint.setEnabled(true);
                                            }

                                            jsPlumb.detach(connection);
                                        }
                                    });
                                }

                                $(this).dialog('close');
                            },
                            "CANCEL" : function () {
                                $(this).dialog('close');
                            }
                        }
                    });
                }
            } else {
                alert("A connection already exists between the source and the target!!");
            }
        } else {
            alert("Cannot create a connection between an object and itself");
        }
        
    } else {
        alert("One of the connection elements has reached its connection limit!!");
    }

    
    return false;
});
    // Nested Accordion code for the side tool-bar
    var parentDivs = $('#nestedAccordion div');
    var childDivs = $('#nestedAccordion h3').siblings('div');
$('#nestedAccordion h2').click(function(){
    parentDivs.slideUp();
    if($(this).next().is(':hidden')) {
        $(this).next().slideDown();
    } else {
        $(this).next().slideUp();
    }
});
$('#nestedAccordion h3').click(function(){
    childDivs.slideUp();
    if($(this).next().is(':hidden')){
        $(this).next().slideDown();
    } else {
        $(this).next().slideUp();
    }
});
$( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

// Converting all the buttons to the animated one
$('.a_button').button();

/* Radio button behaviours*/
$radios = $('.op-select :radio');
$radios.on('change',function(){
   $radios.not(this).prop('checked',false);
});

// Adding entities
$('#Add-REntity').click(function(){
    if($("#REName")[0].value.indexOf("-") != -1)
    {
        $( "#err-dialog" ).text("Contains '-'");
        $( "#err-dialog" ).dialog();
    }
    else if(checkInputVal($("#REName")[0].value,allEntities) == -1)  {
        $("#REName")[0].value = $("#REName")[0].value.trim();
        $("#REName")[0].value = $("#REName")[0].value.replace(" ","-");
        allEntities.push($("#REName")[0].value);
        var entityName = $("#REName")[0].value,
            entitySuffix = "-entity",
            entityID = "#"+entityName+entitySuffix;

        $("#canvas").append(createEntityWithName(entityName));
        $( "#REName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(entityID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            containment: entityName+entitySuffix,
            ConnectionsDetachable:false,
            isSource: true
            //isTarget : true
        });
        jsPlumb.makeTarget($(entityID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Rectangle"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });
        jsPlumb.draggable(entityName+entitySuffix,{
            containment : "parent"
        });

        $(entityID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
    } else 
    {
        $( "#err-dialog" ).text("Already contains an entity of the same name!");
        $( "#err-dialog" ).dialog();
    }
});
$('#Add-WEntity').click(function(){
    if($("#WEName")[0].value.indexOf("-") != -1)
    {
        $( "#err-dialog" ).text("Contains '-'");
        $( "#err-dialog" ).dialog();
    }    
    else if(checkInputVal($("#WEName")[0].value,allEntities) == -1) 
    {
        $("#WEName")[0].value = $("#WEName")[0].value.trim();
        $("#WEName")[0].value = $("#WEName")[0].value.replace(" ","-");
        var weakEntityName = $("#WEName")[0].value
            weakEntitySuffix = "-weak-entity",
            weakEntityID = "#"+weakEntityName+weakEntitySuffix;
        allEntities.push(weakEntityName);

        $("#canvas").append(createWeakEntityWithName(weakEntityName));
        $( "#WEName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        var addedEndpoint = jsPlumb.addEndpoint($(weakEntityID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            containment: weakEntityName+weakEntitySuffix,
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(weakEntityID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Rectangle"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });
        jsPlumb.draggable(weakEntityName+weakEntitySuffix,{
            containment : "parent"
        });

        $(weakEntityID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
    } else 
    {
        $( "#err-dialog" ).text("Already contains an entity of the same name!");
        $( "#err-dialog" ).dialog();
    }
});

//adding relationships
$('#Add-RRName').click(function(){

    if($("#RRName")[0].value.indexOf("-") != -1)
    {
        $( "#err-dialog" ).text("Contains '-'");
        $( "#err-dialog" ).dialog();
    }
    else if(checkInputVal($("#RRName")[0].value,allRelationships) == -1)  
    {   
        $("#RRName")[0].value = $("#RRName")[0].value.trim();
        $("#RRName")[0].value = $("#RRName")[0].value.replace(" ","-");
        allRelationships.push($("#RRName")[0].value);
        var relationshipName = $("#RRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#RRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });
        
        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding ISA relationships
$('#Add-ISARName').click(function(){


        
    var relationshipSuffix = "-isa-relationship",
        relationshipID = "#"+relationshipCounter+relationshipSuffix;

    allRelationships.push(relationshipID);

    $("#canvas").append(createISARelationshipWithId(relationshipID.slice(1)));
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(relationshipID), {
        endpoint : ["Image", defaultEndpointProperties],
        //anchor: ["Perimeter", { shape : "Rectangle"} ],
        anchor: "Right",
        containment: relationshipID.slice(1),
        ConnectionsDetachable:false,
        isSource: true
    });

    jsPlumb.makeTarget($(relationshipID), {
        isTarget : true,
        anchor: ["Perimeter", { shape : "Diamond"} ],
        endpoint : ["Dot", { radius : 1}],
        connector : "Straight"
    });

    jsPlumb.draggable(relationshipID.slice(1),{
        containment : "parent"
    });

    relationshipCounter++;
    $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
});

//adding ISA relationships
$('#Add-OPR').click(function(){

    $("#op-dialog").dialog();
});

$('#op-selected').click(function(){
    $("#op-dialog").dialog('close');
    var relationshipType;

    var res = $('input[name="OP-select"]:checked').val();
    if(res == 0)
    {
        relationshipType = "union";
    }
    else{
        relationshipType = "interection";
    }
        
    var relationshipSuffix = "-"+relationshipType+"-op-relationship",
        relationshipID = "#"+relationshipCounter+relationshipSuffix;

    allRelationships.push(relationshipID);

    $("#canvas").append(createOPRelationshipWithIdAndType(relationshipID.slice(1),relationshipType));
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(relationshipID), {
        endpoint : ["Image", defaultEndpointProperties],
        //anchor: ["Perimeter", { shape : "Rectangle"} ],
        anchor: "Right",
        containment: relationshipID.slice(1),
        ConnectionsDetachable:false,
        isSource: true
    });

    jsPlumb.makeTarget($(relationshipID), {
        isTarget : true,
        anchor: ["Perimeter", { shape : "Diamond"} ],
        endpoint : ["Dot", { radius : 1}],
        connector : "Straight"
    });

    jsPlumb.draggable(relationshipID.slice(1),{
        containment : "parent"
    });

    relationshipCounter++;
    $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
});

//adding Decomposed relationships
$('#Add-DRName').click(function(){
    $("#DRName")[0].value = $("#DRName")[0].value.replace(" ","_");
    if(checkInputVal($("#DRName")[0].value,allRelationships) == -1)  {
        
        var relationshipName = $("#DRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-dc-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createDRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#DRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding EX relationships
$('#Add-EXRName').click(function(){
    $("#EXRName")[0].value = $("#EXRName")[0].value.replace(" ","_");
    if(checkInputVal($("#EXRName")[0].value,allRelationships) == -1)  {
        
        var relationshipName = $("#EXRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-ex-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createEXRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#EXRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding ID relationships
$('#Add-IDRName').click(function(){
    $("#IDRName")[0].value = $("#IDRName")[0].value.replace(" ","_");
    if(checkInputVal($("#IDRName")[0].value,allRelationships) == -1)  {
        
        var relationshipName = $("#IDRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-id-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createIDRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#IDRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

$( "#AttrTypeSet" ).buttonset();
$( document ).tooltip();
// Hover states on the static widgets
$( "#dialog-link, #icons li" ).hover(
    function() {
    $( this ).addClass( "ui-state-hover" );
    },
    function() {
    $( this ).removeClass( "ui-state-hover" );
    }
);
$( "#Add-Attribute-Entity" ).click(function() {
    /*var ops= ['qwerty','asdfgh'];
    $( '#tags' ).autocomplete({source: ops});
    $( "#dialog" ).dialog();*/
    if($("#EAttrName")[0].value.indexOf("-") != -1)
    {
        $( "#err-dialog" ).text("Contains '-'");
        $( "#err-dialog" ).dialog();
    }
    else
    {
        var attributeName = $("#EAttrName")[0].value.trim(),
            attributeSuffix = "-attribute",
            attributeID = "#"+attributeName+attributeSuffix;

        attributeName = attributeName.replace(" ","-");
        $("#canvas").append(createAttributeWithName(attributeName));

        $( "#EAttrName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(attributeID), {
                endpoint : ["Image", defaultEndpointProperties],
                anchor: "Right",
                containment: attributeName+attributeSuffix,
                ConnectionsDetachable:false,
                isSource: true
            });

        jsPlumb.makeTarget($(attributeID), {
                isTarget : true,
                anchor: ["Perimeter", { shape : "Ellipse"} ],
                endpoint : ["Dot", { radius : 1}],
                connector : "Straight",
                maxConnections : 1
            });
        jsPlumb.draggable(attributeName+attributeSuffix,{
            containment : "parent"
        });
        $(attributeID).contextMenu(contextMenuSettings.method,attributeMenu,contextMenuSettings.option);
    }
});

//invoke tabs
$( "#tabs" ).tabs();

//universal left-click
$(document).bind("mouseup", function(e) {
    if (e.which == 1) {  
        $(".iw-contextMenu").hide();
    }
    else if(e.which == 3) {
        var this_element = e.target.id;
        if(this_element == "canvas") {
            //universal context menu here
            $("#canvas").contextMenu(contextMenuUniSettings.method,uniMenu,contextMenuUniSettings.option);
        }
    }
});

});</script>
</head>
<body>
<div id="topheader">
A CS4221 project by P05 --unfinished version--
</div>
    
<div id="tabs">
    <ul>
    <li><a href="#tabs-ERD">ERD view</a></li>
    <li><a href="#tabs-Normal">Normal view</a></li>
    </ul>
    <div id="tabs-ERD">
    <h1>Welcome to DBMod!</h1>
    <p>Design your very own ER-diagrams and we will verify them for you!</p>
    <div id="content">
    <div id="sidebar">
    <div id="nestedAccordion">
    <h2>ADD ENTITY</h2>
            <div>
            <h3 class="subheader">Regular Entity</h3>
                <div><input type="text" name="REName" id="REName" title="Name of New Regular Entity">
                <button id="Add-REntity" class="a_button">Add it!</button></div>
            <h3 class="subheader">Weak Entity</h3>
                <div><input type="text" name="WEName" id="WEName" title="Name of New Weak Entity">
                <button id="Add-WEntity" class="a_button">Add it!</button></div>
            </div>
            <h2>ADD RELATIONSHIP</h2>
            <div>
            <h3 class="subheader">Regular Relationship</h3>
            <div><input type="text" name="RRName" id="RRName" title="Name of New Regular Relationship">
            <button id="Add-RRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">ISA Relationship</h3>
            <div><button id="Add-ISARName" class="a_button">Add it!</button></div>
            <h3 class="subheader">OP Relationship</h3>
            <div><button id="Add-OPR" class="a_button">Add it!</button></div>
            <h3 class="subheader">Decomp Relationship</h3>
            <div><input type="text" name="DRName" id="DRName" title="Name of New Decomp Relationship">
            <button id="Add-DRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">EX Relationship</h3>
            <div><input type="text" name="EXRName" id="EXRName" title="Name of New EX Relationship">
            <button id="Add-EXRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">ID Relationship</h3>
            <div><input type="text" name="IDRName" id="IDRName" title="Name of New ID Relationship">
            <button id="Add-IDRName" class="a_button">Add it!</button></div>
            </div>
            <h2>ADD ATTRIBUTE</h2>
            <div>
            <h3 class="subheader">Attribute</h3>
                <div><input type="text" name="EAttrName" id="EAttrName" title="Name of Attribute">
                <button id="Add-Attribute-Entity" class="a_button">Add it!</button></div>
            </div>
        </div>
    </div>
    <div id="canvas">
    </div>
    </div>
    <div id="dialog" title="Attach to?" style="display:none;">
    <input id="tags" /><button class="a_button">Attach!</button>
    </div>
    <div id="add-entity-dialog" title="Added Entity" style="display:none;">
    </div>
    <div id="err-dialog" title="Error!" style="display:none;">
    <p>Please check your input!</p>
    </div>
    <div id="op-dialog" title="Choose Type of Operation" style="display:none;">
        <input type="radio" name="OP-select" value="0" checked> Union
        <input type="radio" name="OP-select" value="1" > Intersection<br><br>
        <button id="op-selected" class="a_button">Add it!</button>
    </div>

    <div id="attr0-dialog" title="Choose Cardinality of Edge" style="display:none;">
        <input type="radio" name="attr0-select" value="1" checked>1</input>
        <br />
        <input type="radio" name="attr0-select" value="m" >m</input>
        <!--button id="attr0-selected" class="a_button">Edit it!</button-->
    </div>
    
    <div id="attr1-dialog" title="Choose Cardinality of Attribute" style="display:none;">
        The Attribute is: 
        <input type="radio" name="attr1-select" value="0" checked> 1 - 1
        <input type="radio" name="attr1-select" value="1" > 1 - m
        <input type="radio" name="attr1-select" value="2" > m - 1
        <input type="radio" name="attr1-select" value="3" > m - m<br><br>
    </div>

    <div id="attr2-dialog" title="Choose Cardinality of Attribute" style="display:none;">
        Select the role of parent in the new connection : 
        <br />
        <input type="radio" name="attr1-select" value="0" checked> Parent entity
        <input type="radio" name="attr1-select" value="1" > Child entity
        <br />
    </div>
    
    </div>

<div id="tabs-Normal">
<p>In this view you can specify FDs and MVDs for us to do normalization</p>

</div>
</div>

    
    
</body>
</html>