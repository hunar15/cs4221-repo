<!doctype html>
<html lang="us">
<head>
<meta charset="utf-8">
<title>DBMod - ER-Diagram Case Tool 4 U</title>
<link href="css/jquery-ui-1.10.3.custom.css" rel="stylesheet">
<link href="css/dbmod.css" rel="stylesheet">
<link href="css/contextMenu.css" rel="stylesheet">
<script src="js/jquery-1.9.1.js"></script>
<script src="TableManager.js"></script>
<script src="algo_simple.js"></script>
<script src="js/jquery-ui-1.10.3.custom.js"></script>
<script src="js/contextMenu.js"></script>
<script src="js/contextMenu.min.js"></script>
<script src="js/html2canvas.js"></script>
<script type="text/javascript" src="js/jquery.jsPlumb-1.5.3-min.js "></script>
<script type="text/javascript" src="js/jsPlumbSetup.js "></script>
<script type="text/javascript" src="js/er-validate.js "></script>
<script>
$(function() {
    /*
    TODO:
        1. Replace all alerts with common error dialog trigger
        2. hiding of the connection drag images when inactive 
        3. Add proper box for confirm
        4. Addition of the validation of the schema 
    */
    // Storage variable


    var allEntities = [];
    var allRelationships = [];
    var defaultConnectionPaintStyle = {lineWidth:2,strokeStyle:'rgb(0,0,0)'},
        defaultOnHoverConnectionPaintStyle = {lineWidth:5,strokeStyle:'rgb(143,214,0)'}
    var defaultEndpointProperties = { src : "img/littledot.png",
                                                    cssClass : "endpoint-entity" };
    var current_component_div = "";
    var entityAlreadyExistsMessage = "Already contains an entity of the same name!";
    //context menu for entity and relationship
    var contextMenuSettings={
        method:'menu',
        option:{
            afterOpen : function (data,e) {
                //records the latest context menu's linked component
                current_component_div = data.trigger.context.id;
            },
            triggerOn: 'click',
            displayAround: 'cursor',
            mouseClick: 'right',
            verAdjust: 0,
            horAdjust: 0,
            top:'auto',
            left:'auto',
            sizeStyle:'auto',
            position: 'auto',
    }};
    var contextMenuUniSettings={
        method:'menu',
        option:{
            onClose : function (data,e) {
                //records the latest context menu's linked component
                $("#canvas").contextMenu('destroy');
            },
            triggerOn: 'click',
            displayAround: 'cursor',
            mouseClick: 'right',
            verAdjust: 0,
            horAdjust: 0,
            top:'auto',
            left:'auto',
            sizeStyle:'auto',
            position: 'auto',
    }};
    //functions are placeholders for now

    //Group select and drag


    var commonMenu = [{
        name: 'Edit Name',
        fun: function () {
            $("#edit-dialog").dialog({
                resizable : false,
                modal : false,
                buttons : {
                    "OK" : function () {
                        var newName = $("#edit-new-name").val().trim();
                        if(newName == "") {
                            //TODO: Properly validate values, for ex through universal validator?
                            spawnErrorDialogWithMessage("Invalid name!");
                        } else {
                            if(editComponent(newName)) {
                                $(this).dialog('close');
                            }
                        }
                    },
                    "CANCEL" : function () {
                        $(this).dialog('close');
                    }
                }
            });
        }}, {
        name: 'Delete',
        fun: function (e) {
            deleteComponent();
        }}];

    var commonMenuNoEdit = [{
            name: 'Delete',
            fun: function (e) {
                deleteComponent();
            }
        }];
    var attributeMenu = [{
        name: 'Edit Name',
        fun: function () {
            $("#edit-dialog").dialog({
                resizable : false,
                modal : false,
                buttons : {
                    "OK" : function () {
                        var newName = $("#edit-new-name").val().trim();
                        if(newName == "") {
                            //TODO: Properly validate values, for ex through universal validator?
                            spawnErrorDialogWithMessage("Invalid name!");
                        } else if( hasCoAttributeWithSameName(current_component_div,newName) ) {

                            spawnErrorDialogWithMessage("An attribute with the same name is already connected!");
                        } else {
                            if(editComponent(newName)) {
                                $(this).dialog('close');
                            }
                        }
                    },
                    "CANCEL" : function () {
                        $(this).dialog('close');
                    }
                }
            });
        }}, {
   name: 'Toggle Identifying Attribute',
        fun: function () {
            alert('toggle id key')
        }}, {
   name: 'Delete',
        fun: function () {
            deleteComponent();
        }}];
    var uniMenu = [{
        name: 'Add Entity',
        fun: function () {
            alert('prompt for new name')
        }}, {
        name: 'Add Relationship',
        fun: function (data,e) {
            console.log(data);
        }}, {
        name: 'Add Attribute',
        fun: function (data,e) {
            console.log(data);
        }}];
    /*
        Counters of relationships with same name
            1. ISA-counter
            2. Union-OP-counter
            3. Intersection-OP-counter
            4. 
     */
    var relationshipCounter = 0,
        attributeCounter = 0,
        entityCounter = 0;

    function deleteComponent() {
        jsPlumb.detachAllConnections(current_component_div);
        jsPlumb.selectEndpoints({ source : current_component_div}).remove();
        $("#"+current_component_div).remove();
    }

    function editComponent(name) {
       // debugger;
        if(isEntityType($("#"+current_component_div)) && !shouldCreateEntity(name)) {
            spawnErrorDialogWithMessage(entityAlreadyExistsMessage);
            return false;
        } else {
            $("#"+current_component_div+" > div > strong").html(name);
            jsPlumb.repaintEverything();
            return true;
        }
    }

    function sanitizeId(string) {
        string = string.replace(/#/g,'_1_');
        string = string.replace(/&/g,'_2_');
        string = string.replace(/%/g,'_3_');
        string = string.replace(/%/g,'_4_');
        string = string.replace(/\s/g,'-');
        return string;
    }
    
    function sanitizeName(string) {
        string = string.replace(/\s+/g,' ');
        return string;
    }

    function spawnErrorDialogWithMessage (errorMessage) {
        $( "#err-dialog" ).text(errorMessage);
        $( "#err-dialog" ).dialog();
    }
    function getConnectionProperty(source, target, perimeterType, isContinuous) {
        var anchorProp = isContinuous ? "Continuous" : ["Perimeter" , {shape : perimeterType}];
        var newProperty = {
                        source: source,
                        target: target,
                        paintStyle:defaultConnectionPaintStyle,
                        hoverPaintStyle:defaultOnHoverConnectionPaintStyle,
                        anchor: anchorProp,
                        endpoint : "Dot",
                        endpointStyle : { radius : 1}
                    };

        return newProperty;
    }

    function doesConnectionExist(source, target) {
        var totalNumberOfConnections = jsPlumb.getConnections({ source : source, target : target}) +
                                       jsPlumb.getConnections({ source : target, target : source});
        return (totalNumberOfConnections.length > 0);
    }

    function hasAttributeWithSameName(nonAttributeObject, attributeName) {
        var allConnections,
            //attributeName = $("#"+attributeObject.attr("id")+ " > div > strong").html(),
            attributeSelector = $("strong:contains('"+attributeName+"')").parent().parent();


        allConnections = jsPlumb.getConnections({ source : attributeSelector, target : nonAttributeObject});

        for( var i in allConnections) {
            var currentSelector = $("#"+allConnections[i].sourceId);
            if(isAttributeType(currentSelector))
                return true;
        }

        allConnections = jsPlumb.getConnections({ target : attributeSelector, source : nonAttributeObject});

        for( var i in allConnections) {
            var currentSelector = $("#"+allConnections[i].targetId);
            if(isAttributeType(currentSelector))
                return true;
        }

        return false;
    }

    function hasCoAttributeWithSameName(attributeId,name) {
        
        /*
            Program logic : 
                Find all canvas objects with the same content.
                For all of those objects, see if they are of attribute type and make a connection 
                with the connector of the attribute..javasc 
        */
        //debugger;
        var isAttributeFromId = function(id) {
            return id.split('-').slice(-1)[0] == 'attribute';
        };

        var allInnerElementsContainingTheName = $("strong:contains('"+name+"')");

        //Does name conflict occur at all in the whole canvas
        if (allInnerElementsContainingTheName.length != 0) {
            var allElementsContainingTheName =  allInnerElementsContainingTheName.parent().parent(),
                allConnectionsOfObjectToBeEdited = jsPlumb.getConnections({source: attributeId})
                                        .concat(jsPlumb.getConnections({target : attributeId}));
            //Is the attribute connected at all?
            if (allConnectionsOfObjectToBeEdited.length != 0) {
                var objectAtOtherEndOfConnection = isAttributeFromId(allConnectionsOfObjectToBeEdited[0].endpoints[0].elementId) ? allConnectionsOfObjectToBeEdited[0].endpoints[1].elementId : allConnectionsOfObjectToBeEdited[0].endpoints[0].elementId;

                if(allElementsContainingTheName != 0) {
                    for(var counter in allElementsContainingTheName) {
                        var eachElement = allElementsContainingTheName[counter];

                        var existingConnection = jsPlumb.getConnections({source: eachElement, target: objectAtOtherEndOfConnection})
                                                .concat(jsPlumb.getConnections({target : eachElement, source: objectAtOtherEndOfConnection}));
                        if(isAttributeType($(eachElement)) && existingConnection.length!=0)
                            return true;
                    }
                }
            }
        }
        
        return false;
    }
    function doesConnectionHaveParameterWithValue (connectionObject, parameter, expectedValue) {
        return (connectionObject.getParameters()[parameter] == expectedValue);
    }
    //For functions where only parent connection can exist
    function hasParentConnection(object) {
        var currentConnections;

        //First check all connections where "object" is the source

        currentConnections = jsPlumb.getConnections({source : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isParentConnection",true)) {
                return true;
            }
        };

        //Next check all connections where "object" is the target

        currentConnections = jsPlumb.getConnections({target : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isParentConnection",true)) {
                return true;
            }
        };

        return false;
    }

    //For functions where only normal entity connection can exist
    function hasNormalEntityConnection(object) {
        var currentConnections;

        //First check all connections where "object" is the source

        currentConnections = jsPlumb.getConnections({source : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",true)) {
                return true;
            }
        };

        //Next check all connections where "object" is the target

        currentConnections = jsPlumb.getConnections({target : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",true)) {
                return true;
            }
        };

        return false;
    }

    //For functions where only normal entity connection can exist
    function hasWeakEntityConnection(object) {
        var currentConnections;

        //First check all connections where "object" is the source

        currentConnections = jsPlumb.getConnections({source : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",false)) {
                return true;
            }
        };

        //Next check all connections where "object" is the target

        currentConnections = jsPlumb.getConnections({target : object});

        for (var i = 0; i < currentConnections.length; i++) {
            if(doesConnectionHaveParameterWithValue(currentConnections[i],"isNormalEntityConnection",false)) {
                return true;
            }
        };

        return false;
    }

    jsPlumb.Defaults.Container = $("#canvas");
    jsPlumb.Defaults.Connector = "Straight";
    jsPlumb.Defaults.PaintStyle = defaultConnectionPaintStyle;
    
    // Functions to check inputs
    function checkInputVal(val,array){
        if(val == "") {
            return 0;
        } else {
            return ($.inArray(val,array));
        }
    }

//Add connection listener
jsPlumb.bind('beforeDrop', function (info) {
    /*
    Structure of "info" object
        {
          connection         :     the new Connection.  you can register listeners on this etc.
          sourceId         :    id of the source element in the Connection
          targetId        :    id of the target element in the Connection
          source        :    the source element in the Connection
          target        :    the target element in the Connection
          sourceEndpoint    :    the source Endpoint in the Connection
          targetEndpoint    :    the targetEndpoint in the Connection
        }
    */
    //alert(JSON.stringify(info.sourceId));
    var QsourceObj = $("#"+info.sourceId),
        QtargetObj = $("#"+info.targetId),
        newConnection = null;

    if(!hasReachedConnectionLimit(QsourceObj) && !hasReachedConnectionLimit(QtargetObj) ) {
        //TODO : enable connection between an attribute and relationship
        //TODO : enable recursive relationship between entity and attribute

        if( info.sourceId != info.targetId) {
            if(!doesConnectionExist(QsourceObj,QtargetObj)) {
                if(isEntityType(QsourceObj) && isEntityType(QtargetObj)) {
                    alert("Cannot directly join 2 entity types");
                } else if( (isRelationshipType(QsourceObj) && isEntityType(QtargetObj)) ||
                            (isRelationshipType(QtargetObj) && isEntityType(QsourceObj))) {
                    
                    var entityObj = isRelationshipType(QsourceObj) ? QtargetObj : QsourceObj,
                        relationShipObj = isRelationshipType(QsourceObj) ? QsourceObj : QtargetObj;

                    if(isRegularRelationshipType(relationShipObj)) {
                        var labelOverlay = null,
                            connectionProperty = null

                        $("#attr0-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var labelVal = $("#attr0-dialog > input:checked").val();

                                    labelOverlay = [ "Label", { label : labelVal, location : 0.5, cssClass : "cardinality"}];
                            
                                    connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond",true);
                    
                                    connectionProperty.overlays = [ labelOverlay];
                                    newConnection = jsPlumb.connect(connectionProperty);
                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }
                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });
                        

                    } else if (isSingleParentRelationshipType(relationShipObj)) {
                        /*
                            Conditional checks for relationships where the parent is restricted to 1 entity
                        */
                        var overlayConfig = null,
                            connectionProperty = null,
                            isTargetEntity = isEntityType(QtargetObj),
                            isParentConnection = false;

                        $("#attr2-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var selectedOption = $("#attr2-dialog > input:checked").val();

                                    isParentConnection = (selectedOption == "0") ? true : false;

                                    if (!hasParentConnection(relationShipObj) && isParentConnection) {
                                        overlayConfig = [["Arrow", { width : 10, length: 10, location : 1, direction: 1}]];
                                    } else if(hasParentConnection(relationShipObj) && isParentConnection) {
                                        alert("Cannot have more than 1 parent connection!!");
                                        return false;
                                    }

                                    connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond",false);

                                    if(overlayConfig != null) {
                                        connectionProperty.overlays = overlayConfig;
                                    }

                                    connectionProperty.parameters = {};
                                    connectionProperty.parameters.isParentConnection = isParentConnection;

                                    newConnection = jsPlumb.connect(connectionProperty);

                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }

                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });

                    } else if (isNormalWeakRelationshipType(relationShipObj)) {
                        
                        var isNormalEntityConnection = (isNormalEntityType(QsourceObj)||isNormalEntityType(QtargetObj));
                            overlayConfig = null,
                            isParentConnection = null;

                        $("#attr2-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var selectedOption = $("#attr2-dialog > input:checked").val();

                                    isParentConnection = (selectedOption == "0") ? true : false;

                                    if(isParentConnection) {
                                        if (hasParentConnection(relationShipObj)) {
                                            alert("Cannot have more than 1 parent connections");
                                            return false;
                                        } else {
                                            //no overlays for parent connection
                                        }
                                    } else {
                                        if (isNormalEntityConnection ) {
                                            alert("Cannot create non-parent connection with normal entity.");
                                            return false;
                                        } else if ((getConnectionCount(relationShipObj) > 0) && !hasParentConnection(relationShipObj) ) {
                                            alert("Cannot have 2 child connections.")
                                            return false;
                                        } else {
                                            overlayConfig = [["Arrow", { width : 10, length: 10, location : 1, direction: 1}]];
                                        }

                                    }

                                    connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond",false);

                                    if(overlayConfig != null) {
                                        connectionProperty.overlays = overlayConfig;
                                    }

                                    connectionProperty.parameters = {};
                                    connectionProperty.parameters.isNormalEntityConnection = isNormalEntityConnection;
                                    connectionProperty.parameters.isParentConnection = isParentConnection;

                                    newConnection = jsPlumb.connect(connectionProperty);

                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }

                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });  
                    }
                 } else if( ((isEntityType(QsourceObj)||isRegularRelationshipType(QsourceObj)) && isAttributeType(QtargetObj)) ||
                           ((isEntityType(QtargetObj)||isRegularRelationshipType(QtargetObj)) && isAttributeType(QsourceObj))) {
                    
                    var attributeEndpoint, overlayConfig,
                        attribObj = isAttributeType(QtargetObj) ? QtargetObj : QsourceObj,
                        nonAttribObj= isAttributeType(QtargetObj) ? QsourceObj : QtargetObj,
                        toAddLater = null,
                        connectionProperty = null;


                    if(!hasAttributeWithSameName(nonAttribObj,$("#"+attribObj.attr("id")+ " > div > strong").html())) {
                        //TODO: Check if attribute connection with the same parent exists or not
                        //var arrowDirection, arrowLocation;
                        var arrowWidth = 10,
                            arrowLength = 10;


                        $("#attr1-dialog").dialog({
                            resizable : false,
                            modal : true,
                            buttons : {
                                "OK" : function () {
                                    var selectedOption = $("#attr1-dialog > input:checked").val();

                                    switch(selectedOption) {
                                        case "0":
                                            overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                        ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
                                        break;
                                        case "1":
                                            overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                        ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}],
                                        ["Arrow", { width : arrowWidth, length: arrowLength, location : 11, direction: -1}]];
                                        break;
                                        case "2":
                                            overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
                                        break;
                                        case "3":
                                            overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}],
                                        ["Arrow", { width : arrowWidth, length: arrowLength, location : 11, direction: -1}]];
                                        break;
                                    }

                                    connectionProperty = getConnectionProperty(attribObj,nonAttribObj,"Ellipse",false);
                                    attributeEndpoint = jsPlumb.selectEndpoints({ source: attribObj});
                                    connectionProperty.overlays = overlayConfig;
                                    newConnection = jsPlumb.connect(connectionProperty);
                                    //attributeEndpoint.setEnabled(false);

                                    if(newConnection !== null) {
                                         newConnection.bind('click', function (connection) {
                                            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                            if(deleteConnection) {
                                                if(isAttributeType(fetchParentOfEndpoint(connection.endpoints[0])) ||(isAttributeType(fetchParentOfEndpoint(connection.endpoints[1])))) {
                                                    //attributeEndpoint.setEnabled(true);
                                                }

                                                jsPlumb.detach(connection);
                                            }
                                        });
                                    }

                                    $(this).dialog('close');
                                },
                                "CANCEL" : function () {
                                    $(this).dialog('close');
                                }
                            }
                        });
                    } else {
                        alert("Another attribute with the same name already exists!!");
                        return false;
                    }
                    
                }
            } else if( (isRegularRelationshipType(QsourceObj) && isEntityType(QtargetObj)) ||
                            (isRegularRelationshipType(QtargetObj) && isEntityType(QsourceObj))) {
                var entityObj = isRelationshipType(QsourceObj) ? QtargetObj : QsourceObj,
                        relationShipObj = isRelationshipType(QsourceObj) ? QsourceObj : QtargetObj;

                var labelOverlay = null,
                    connectionProperty = null

                $("#attr0-dialog").dialog({
                    resizable : false,
                    modal : true,
                    buttons : {
                        "OK" : function () {
                            var labelVal = $("#attr0-dialog > input:checked").val();

                            labelOverlay = [ "Label", { label : labelVal, location : 0.5, cssClass : "cardinality"}];
                    
                            connectionProperty = getConnectionProperty(relationShipObj,entityObj,"Diamond",true);
                            connectionProperty.anchor = null;
                            delete connectionProperty.anchor;
                            connectionProperty.anchors = [ "Continuous", "Continuous"];
                            connectionProperty.overlays = [ labelOverlay];
                            newConnection = jsPlumb.connect(connectionProperty);
                            if(newConnection !== null) {
                                 newConnection.bind('click', function (connection) {
                                    var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

                                    if(deleteConnection) {
                                        jsPlumb.detach(connection);
                                    }
                                });
                            }
                            $(this).dialog('close');
                        },
                        "CANCEL" : function () {
                            $(this).dialog('close');
                        }
                    }
                });
            } else {
                alert("A connection already exists between the source and the target!!");
            }
        } else {
            alert("Cannot create a connection between an object and itself");
        }
        
    } else {
        alert("One of the connection elements has reached its connection limit!!");
    }

    
    return false;
});
    // Nested Accordion code for the side tool-bar
    var parentDivs = $('#nestedAccordion div');
    var childDivs = $('#nestedAccordion h3').siblings('div');
$('#nestedAccordion h2').click(function(){
    parentDivs.slideUp();
    if($(this).next().is(':hidden')) {
        $(this).next().slideDown();
    } else {
        $(this).next().slideUp();
    }
});
$('#nestedAccordion h3').click(function(){
    childDivs.slideUp();
    if($(this).next().is(':hidden')){
        $(this).next().slideDown();
    } else {
        $(this).next().slideUp();
    }
});
$( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

// Converting all the buttons to the animated one
$('.a_button').button();

/* Radio button behaviours*/
$radios = $('.op-select :radio');
$radios.on('change',function(){
   $radios.not(this).prop('checked',false);
});

function shouldCreateEntity(name) {
    var matchingObjects = $("strong:contains('"+name+"')").parent().parent();
    if( matchingObjects.length != 0) {
        for( var i in matchingObjects) {
            if(isEntityType($(matchingObjects[i])))
                return false;
        }
    }
    return true;
}
// Adding entities
$('#Add-REntity').click(function(){
    $("#REName")[0].value = $("#REName")[0].value.trim();

    if($("#REName")[0].value == "")
    {
        $( "#err-dialog" ).text("Invalid name!");
        $( "#err-dialog" ).dialog();
    }
    else if(shouldCreateEntity($("#REName")[0].value))  {
        
        //$("#REName")[0].value = $("#REName")[0].value;
        allEntities.push($("#REName")[0].value);
        var entityName = sanitizeName($("#REName")[0].value),
            entitySuffix = "-entity",
            entityID = "#"+sanitizeId(entityName)+"-"+entityCounter+entitySuffix;

        $("#canvas").append(createEntityWithNameAndId(entityName,entityID.slice(1)));
        $( "#REName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(entityID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            isSource: true,
            container: entityID.slice(1),
            ConnectionsDetachable:false
            //isTarget : true
        });
        jsPlumb.makeTarget($(entityID), {
            isTarget : true,
            anchor: "Continuous",
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });
        jsPlumb.draggable($(entityID),{
            containment : "parent"
        });

        entityCounter++;
        $(entityID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
    } else 
    {
        spawnErrorDialogWithMessage(entityAlreadyExistsMessage);
    }
});
$('#Add-WEntity').click(function(){
    $("#WEName")[0].value = $("#WEName")[0].value.trim();
    if($("#WEName")[0].value == "")
    {
        $( "#err-dialog" ).text("Invalid name!");
        $( "#err-dialog" ).dialog();
    }    
    else if(shouldCreateEntity($("#WEName")[0].value)) 
    {
        var weakEntityName = sanitizeName($("#WEName")[0].value),
            weakEntitySuffix = "-weak-entity",
            weakEntityID = "#"+sanitizeId(weakEntityName)+"-"+entityCounter+weakEntitySuffix;
        allEntities.push(weakEntityName);

        $("#canvas").append(createWeakEntityWithNameAndId(weakEntityName,weakEntityID.slice(1)));
        $( "#WEName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        var addedEndpoint = jsPlumb.addEndpoint($(weakEntityID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            containment: weakEntityName+weakEntitySuffix,
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(weakEntityID), {
            isTarget : true,
            anchor: "Continuous",
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });
        jsPlumb.draggable($(weakEntityID),{
            containment : "parent"
        });

        entityCounter++;
        $(weakEntityID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
    } else 
    {
        $( "#err-dialog" ).text();
        $( "#err-dialog" ).dialog();
    }
});

//adding relationships
$('#Add-RRName').click(function(){

    $("#RRName")[0].value = $("#RRName")[0].value.trim();
    if($("#RRName")[0].value == "")
    {
        $( "#err-dialog" ).text("Invalid name!");
        $( "#err-dialog" ).dialog();
    }
    else if(checkInputVal($("#RRName")[0].value,allRelationships) == -1)  
    {   
        allRelationships.push($("#RRName")[0].value);
        var relationshipName = sanitizeName($("#RRName")[0].value),
            relationshipSuffix = "-"+relationshipCounter+ "-relationship",
            relationshipID = "#"+sanitizeId(relationshipName)+relationshipSuffix;


        allRelationships.push(relationshipID);
        $("#canvas").append(createRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#RRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });
        
        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding ISA relationships
$('#Add-ISARName').click(function(){


        
    var relationshipSuffix = "-isa-relationship",
        relationshipID = "#"+relationshipCounter+relationshipSuffix;

    allRelationships.push(relationshipID);

    $("#canvas").append(createISARelationshipWithId(relationshipID.slice(1)));
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(relationshipID), {
        endpoint : ["Image", defaultEndpointProperties],
        //anchor: ["Perimeter", { shape : "Rectangle"} ],
        anchor: "Right",
        containment: relationshipID.slice(1),
        ConnectionsDetachable:false,
        isSource: true
    });

    jsPlumb.makeTarget($(relationshipID), {
        isTarget : true,
        anchor: ["Perimeter", { shape : "Diamond"} ],
        endpoint : ["Dot", { radius : 1}],
        connector : "Straight"
    });

    jsPlumb.draggable(relationshipID.slice(1),{
        containment : "parent"
    });

    relationshipCounter++;
    $(relationshipID).contextMenu(contextMenuSettings.method,commonMenuNoEdit,contextMenuSettings.option);
});

//adding ISA relationships
$('#Add-OPR').click(function(){

    $("#op-dialog").dialog();
});

$('#op-selected').click(function(){
    $("#op-dialog").dialog('close');
    var relationshipType;

    var res = $('input[name="OP-select"]:checked').val();
    if(res == 0)
    {
        relationshipType = "union";
    }
    else{
        relationshipType = "interection";
    }
        
    var relationshipSuffix = "-"+relationshipType+"-op-relationship",
        relationshipID = "#"+relationshipCounter+relationshipSuffix;

    allRelationships.push(relationshipID);

    $("#canvas").append(createOPRelationshipWithIdAndType(relationshipID.slice(1),relationshipType));
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(relationshipID), {
        endpoint : ["Image", defaultEndpointProperties],
        //anchor: ["Perimeter", { shape : "Rectangle"} ],
        anchor: "Right",
        containment: relationshipID.slice(1),
        ConnectionsDetachable:false,
        isSource: true
    });

    jsPlumb.makeTarget($(relationshipID), {
        isTarget : true,
        anchor: ["Perimeter", { shape : "Diamond"} ],
        endpoint : ["Dot", { radius : 1}],
        connector : "Straight"
    });

    jsPlumb.draggable(relationshipID.slice(1),{
        containment : "parent"
    });

    relationshipCounter++;
    $(relationshipID).contextMenu(contextMenuSettings.method,commonMenuNoEdit,contextMenuSettings.option);
});

//adding Decomposed relationships
$('#Add-DRName').click(function(){
    $("#DRName")[0].value = $("#DRName")[0].value.trim();
    if($("#DRName")[0].value != "")  {
        
        var relationshipName = sanitizeName($("#DRName")[0].value),
            relationshipSuffix = "-"+relationshipCounter+ "-dc-relationship",
            relationshipID = "#"+sanitizeId(relationshipName)+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createDRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#DRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding EX relationships
$('#Add-EXRName').click(function(){
    $("#EXRName")[0].value = $("#EXRName")[0].value.trim();
    if($("#EXRName")[0].value != "")  {
        
        var relationshipName = sanitizeName($("#EXRName")[0].value),
            relationshipSuffix = "-"+relationshipCounter+ "-ex-relationship",
            relationshipID = "#"+sanitizeId(relationshipName)+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createEXRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#EXRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding ID relationships
$('#Add-IDRName').click(function(){
    $("#IDRName")[0].value = $("#IDRName")[0].value.trim();
    if($("#IDRName")[0].value != "")  {
        
        var relationshipName = sanitizeName($("#IDRName")[0].value),
            relationshipSuffix = "-"+relationshipCounter+ "-id-relationship",
            relationshipID = "#"+sanitizeId(relationshipName)+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createIDRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#IDRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        $(relationshipID).contextMenu(contextMenuSettings.method,commonMenu,contextMenuSettings.option);
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

$( "#AttrTypeSet" ).buttonset();
$( document ).tooltip();
// Hover states on the static widgets
$( "#dialog-link, #icons li" ).hover(
    function() {
    $( this ).addClass( "ui-state-hover" );
    },
    function() {
    $( this ).removeClass( "ui-state-hover" );
    }
);
$( "#Add-Attribute-Entity" ).click(function() {
    /*var ops= ['qwerty','asdfgh'];
    $( '#tags' ).autocomplete({source: ops});
    $( "#dialog" ).dialog();*/
    if($("#EAttrName")[0].value.trim() == "")
    {
        $( "#err-dialog" ).text("Invalid name!");
        $( "#err-dialog" ).dialog();
    }
    else
    {
        var attributeName = sanitizeName($("#EAttrName")[0].value.trim()),
            attributeSuffix = "-"+attributeCounter+"-attribute",
            attributeID = "#"+sanitizeId(attributeName)+attributeSuffix;

        //attributeName = attributeName.replace(" ","-");
        $("#canvas").append(createAttributeWithNameAndId(attributeName,attributeID.slice(1)));

        $( "#EAttrName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(attributeID), {
                endpoint : ["Image", defaultEndpointProperties],
                anchor: "Right",
                containment: attributeName+attributeSuffix,
                ConnectionsDetachable:false,
                isSource: true
            });

        jsPlumb.makeTarget($(attributeID), {
                isTarget : true,
                anchor: ["Perimeter", { shape : "Ellipse"} ],
                endpoint : ["Dot", { radius : 1}],
                connector : "Straight",
                maxConnections : 1
            });
        jsPlumb.draggable(attributeID.slice(1),{
            containment : "parent"
        });
        $(attributeID).contextMenu(contextMenuSettings.method,attributeMenu,contextMenuSettings.option);
        attributeCounter++;
    }
});

//invoke tabs
$( "#tabs" ).tabs();

//universal left-click
$("#canvas").bind("mousedown", function(e) {
    if (e.which == 1) {  
        $(".iw-contextMenu").hide();
    }
    else if(e.which == 3) {
        var this_element = e.target.id;
        if(this_element == "canvas") {
            //universal context menu here
            $("#canvas").contextMenu(contextMenuUniSettings.method,uniMenu,contextMenuUniSettings.option);
        }
    }
});

$("#snapshot-select").click( function(){
    html2canvas($('#canvas'), {
        onrendered: function(canvas) {
            var img = canvas.toDataURL();
            window.open(img);
        }
    });
});


});</script>
</head>
<body>
<div id="topheader">
A CS4221 project by P05 --unfinished version--
</div>
    
<div id="tabs">
    <ul>
    <li><a href="#tabs-ERD">ERD view</a></li>
    <li><a href="#tabs-Normal">Normal view</a></li>
    </ul>
    <div id="tabs-ERD">
    <h1>Welcome to DBMod!</h1>
    <p>Design your very own ER-diagrams and we will verify them for you!</p>
    <div id="content">
    <div id="sidebar">
    <div id="nestedAccordion">
    <h2>ADD ENTITY</h2>
            <div>
            <h3 class="subheader">Regular Entity</h3>
                <div><input type="text" name="REName" id="REName" title="Name of New Regular Entity">
                <button id="Add-REntity" class="a_button">Add it!</button></div>
            <h3 class="subheader">Weak Entity</h3>
                <div><input type="text" name="WEName" id="WEName" title="Name of New Weak Entity">
                <button id="Add-WEntity" class="a_button">Add it!</button></div>
            </div>
            <h2>ADD RELATIONSHIP</h2>
            <div>
            <h3 class="subheader">Regular Relationship</h3>
            <div><input type="text" name="RRName" id="RRName" title="Name of New Regular Relationship">
            <button id="Add-RRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">ISA Relationship</h3>
            <div><button id="Add-ISARName" class="a_button">Add it!</button></div>
            <h3 class="subheader">OP Relationship</h3>
            <div><button id="Add-OPR" class="a_button">Add it!</button></div>
            <h3 class="subheader">Decomp Relationship</h3>
            <div><input type="text" name="DRName" id="DRName" title="Name of New Decomp Relationship">
            <button id="Add-DRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">EX Relationship</h3>
            <div><input type="text" name="EXRName" id="EXRName" title="Name of New EX Relationship">
            <button id="Add-EXRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">ID Relationship</h3>
            <div><input type="text" name="IDRName" id="IDRName" title="Name of New ID Relationship">
            <button id="Add-IDRName" class="a_button">Add it!</button></div>
            </div>
            <h2>ADD ATTRIBUTE</h2>
            <div>
            <h3 class="subheader">Attribute</h3>
                <div><input type="text" name="EAttrName" id="EAttrName" title="Name of Attribute">
                <button id="Add-Attribute-Entity" class="a_button">Add it!</button></div>
            </div>
            <h2>SCREEN CAPTURE</h2>
            <div>
            <h3 class="subheader"><button id="snapshot-select" class="a_button">*Snap*</button></h3>
            </div>
        </div>
    </div>
        <div id="canvas">
        </div>
    
    </div>
    <div id="dialog" title="Attach to?" style="display:none;">
    <input id="tags" /><button class="a_button">Attach!</button>
    </div>
    <div id="add-entity-dialog" title="Added Entity" style="display:none;">
    </div>
    <div id="err-dialog" title="Error!" style="display:none;">
    <p>Please check your input!</p>
    </div>
    <div id="op-dialog" title="Choose Type of Operation" style="display:none;">
        <input type="radio" name="OP-select" value="0" checked> Union
        <input type="radio" name="OP-select" value="1" > Intersection<br><br>
        <button id="op-selected" class="a_button">Add it!</button>
    </div>

    <div id="attr0-dialog" title="Choose Cardinality of Edge" style="display:none;">
        <input type="radio" name="attr0-select" value="1" checked>1</input>
        <br />
        <input type="radio" name="attr0-select" value="m" >m</input>
        <!--button id="attr0-selected" class="a_button">Edit it!</button-->
    </div>
    
    <div id="attr1-dialog" title="Choose Cardinality of Attribute" style="display:none;">
        The Attribute is: 
        <input type="radio" name="attr1-select" value="0" checked> 1 - 1
        <input type="radio" name="attr1-select" value="1" > 1 - m
        <input type="radio" name="attr1-select" value="2" > m - 1
        <input type="radio" name="attr1-select" value="3" > m - m<br><br>
    </div>

    <div id="attr2-dialog" title="Choose Cardinality of Attribute" style="display:none;">
        Select the role of parent in the new connection : 
        <br />
        <input type="radio" name="attr1-select" value="0" checked> Parent entity
        <input type="radio" name="attr1-select" value="1" > Child entity
        <br />
    </div>
    
    <div id="edit-dialog" title="Choose New Name" style="display:none;">
        Select the new name of the object :
        <br />
        <input type="text" placeholder="New name" id="edit-new-name"></input>
        <br />
    </div>

    </div>

<div id="tabs-Normal">
<p>In this view you can specify FDs and MVDs for us to do normalization</p>

</div>
</div>

    
    
</body>
</html>