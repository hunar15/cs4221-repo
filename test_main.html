<!doctype html>
<html lang="us">
<head>
<meta charset="utf-8">
<title>DBMod - ER-Diagram Case Tool 4 U</title>
<link href="css/jquery-ui-1.10.3.custom.css" rel="stylesheet">
<link href="css/dbmod.css" rel="stylesheet">
<script src="js/jquery-1.9.1.js"></script>
<script src="js/jquery-ui-1.10.3.custom.js"></script>
<script type="text/javascript" src="js/jquery.jsPlumb-1.5.3.js "></script>
<script type="text/javascript" src="js/jsPlumbSetup.js "></script>
<script>
$(function() {
    // Storage variable
    var allEntities = [];
    var allRelationships = [];
    var defaultConnectionPaintStyle = {lineWidth:2,strokeStyle:'rgb(0,0,0)'},
        defaultOnHoverConnectionPaintStyle = {lineWidth:5,strokeStyle:'rgb(143,214,0)'}
    var defaultEndpointProperties = { src : "img/littledot.png",
                                   cssClass : "endpoint-entity-hover", 
                                   hoverClass: "endpoint-hover" };
    var hoverOverEndpointClass = "endpoint-hover",
        hoverOverEntityClass = "endpoint-entity-hover",
        noHoverOverEntityClass = "endpoint-no-display";

    /*
        Counters of relationships with same name
            1. ISA-counter
            2. Union-OP-counter
            3. Intersection-OP-counter
            4. 
     */
    var relationshipCounter = 0,
        attributeCounter = 0;

    jsPlumb.Defaults.Container = $("#canvas");
    jsPlumb.Defaults.Connector = "Straight";
    jsPlumb.Defaults.PaintStyle = defaultConnectionPaintStyle;
    
    // Functions to check inputs
    function checkInputVal(val,array){
        if(val == "") {
            return 0;
        } else {
            return ($.inArray(val,array));
        }
    }

//Add connection listener
jsPlumb.bind('beforeDrop', function (info) {
    /*
    Structure of "info" object
        {
          connection         :     the new Connection.  you can register listeners on this etc.
          sourceId         :    id of the source element in the Connection
          targetId        :    id of the target element in the Connection
          source        :    the source element in the Connection
          target        :    the target element in the Connection
          sourceEndpoint    :    the source Endpoint in the Connection
          targetEndpoint    :    the targetEndpoint in the Connection
        }
    */
    //alert(JSON.stringify(info.sourceId));
    var QsourceObj = $("#"+info.sourceId),
        QtargetObj = $("#"+info.targetId),
        newConnection = null;

    if(!hasReachedConnectionLimit(QsourceObj) && !hasReachedConnectionLimit(QtargetObj)) {

        if(isEntityType(QsourceObj) && isEntityType(QtargetObj)) {
            alert("Cannot directly join 2 entity types");
            return false;
        } else if( (isRelationshipType(QsourceObj) && isEntityType(QtargetObj)) ||
                    (isRelationshipType(QtargetObj) && isEntityType(QsourceObj))) {
            var labelOverlay = null;

            if(confirm("Press OK for \"m\" cardinality")) {
                //TODO: set Label as "m"
                labelOverlay = [ "Label", { label : "m", location : 0.5, cssClass : "cardinality"}];
            } else {
                labelOverlay = [ "Label", { label : "1", location : 0.5, cssClass : "cardinality"}];
            }

            if(isRelationshipType(QsourceObj)) {
                newConnection = jsPlumb.connect({
                    source: QsourceObj,
                    target: QtargetObj,
                    paintStyle:defaultConnectionPaintStyle,
                    hoverPaintStyle:defaultOnHoverConnectionPaintStyle,
                    anchor: ["Perimeter", { shape : "Diamond"} ],
                    endpoint : "Dot",
                    endpointStyle : { radius : 1},
                    overlays : [ labelOverlay ]
                });
            } else {
                newConnection = jsPlumb.connect({
                    source: QsourceObj,
                    target: QtargetObj,
                    paintStyle:defaultConnectionPaintStyle,
                    hoverPaintStyle:defaultOnHoverConnectionPaintStyle,
                    anchor: ["Perimeter", { shape : "Rectangle"} ],
                    endpoint : "Dot",
                    endpointStyle : { radius : 1},
                    overlays : [ labelOverlay ]
                });
            }
            
        } else if( (isEntityType(QsourceObj) && isAttributeType(QtargetObj)) ||
                   (isEntityType(QtargetObj) && isAttributeType(QsourceObj))) {
            //TODO: Arrows overlays work only when dragging from entity to attribute
            
            var attributeEndpoint, overlayConfig,
                isTargetAttributeType = isAttributeType(QtargetObj),
                toAddLater = null;

            //var arrowDirection, arrowLocation;
            var arrowWidth = 10,
                arrowLength = 10;

            if(confirm("Is attribute 1 - 1 ?")) {
                overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
            } else if (confirm("Is attribute 1 - m ?")) {
                if (isTargetAttributeType) {
                    overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : -11, direction: 1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
                } else {
                    overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : 11, direction: -1}]];
                                //[["PlainArrow", { width : arrowWidth, length: arrowLength, location : 22, direction:1}],
                                //["PlainArrow", { width : arrowWidth, length: arrowLength, location : 11, direction: 1}]];
                                //["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}]];
                }
            } else if (confirm("Is attribute m - 1 ?")) {
                if (isTargetAttributeType) {
                    overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}]];
                } else {
                    overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 0, direction: -1}]];
                }
            } else {
                if (isTargetAttributeType) {
                    overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 1, direction: 1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : -11, direction: 1}]];
                } else {
                    overlayConfig = [["Arrow", { width : arrowWidth, length: arrowLength, location : 11, direction: -1}],
                                ["Arrow", { width : arrowWidth, length: arrowLength, location : 22, direction: -1}]];
                }
            }
            if(isTargetAttributeType) {
                attributeEndpoint = jsPlumb.selectEndpoints({ source: QtargetObj});
                newConnection = jsPlumb.connect({
                    source: QsourceObj,
                    target: QtargetObj,
                    paintStyle:defaultConnectionPaintStyle,
                    hoverPaintStyle:defaultOnHoverConnectionPaintStyle,
                    anchor: ["Perimeter", { shape : "Rectangle"} ],
                    endpoint : "Dot",
                    endpointStyle : { radius : 1},
                    overlays : overlayConfig
                });
            } else {
                attributeEndpoint = jsPlumb.selectEndpoints({ source: QsourceObj});
                newConnection = jsPlumb.connect({
                    source: QsourceObj,
                    target: QtargetObj,
                    paintStyle:defaultConnectionPaintStyle,
                    hoverPaintStyle:defaultOnHoverConnectionPaintStyle,
                    anchor: ["Perimeter", { shape : "Ellipse"} ],
                    endpoint : "Dot",
                    endpointStyle : { radius : 1},
                    overlays : overlayConfig
                });
            }
            attributeEndpoint.setEnabled(false);
           
        }
    } else {
        alert("One of the connection elements has reached its connection limit!!");
        return false;
    }

    if(newConnection !== null) {
         newConnection.bind('click', function (connection) {
            var deleteConnection = confirm("Select OK to delete this connection, CANCEL otherwise");

            if(deleteConnection) {
                if(isAttributeType(fetchParentOfEndpoint(connection.endpoints[0])) ||(isAttributeType(fetchParentOfEndpoint(connection.endpoints[1])))) {
                    attributeEndpoint.setEnabled(true);
                }

                jsPlumb.detach(connection);
            }
        });
    }
    return false;
});
    // Nested Accordion code for the side tool-bar
    var parentDivs = $('#nestedAccordion div');
    var childDivs = $('#nestedAccordion h3').siblings('div');
$('#nestedAccordion h2').click(function(){
    parentDivs.slideUp();
    if($(this).next().is(':hidden')) {
        $(this).next().slideDown();
    } else {
        $(this).next().slideUp();
    }
});
$('#nestedAccordion h3').click(function(){
    childDivs.slideUp();
    if($(this).next().is(':hidden')){
        $(this).next().slideDown();
    } else {
        $(this).next().slideUp();
    }
});
$( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

// Converting all the buttons to the animated one
$('.a_button').button();

// Adding entities
$('#Add-REntity').click(function(){
    $("#REName")[0].value = $("#REName")[0].value.replace(" ","_");
    if(checkInputVal($("#REName")[0].value,allEntities) == -1)  {
        allEntities.push($("#REName")[0].value);
        var entityName = $("#REName")[0].value,
            entitySuffix = "-entity",
            entityID = "#"+entityName+entitySuffix;

        $("#canvas").append(createEntityWithName(entityName));
        $( "#REName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(entityID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            containment: entityName+entitySuffix,
            ConnectionsDetachable:false,
            isSource: true
            //isTarget : true
        });
        jsPlumb.makeTarget($(entityID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Rectangle"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });
        jsPlumb.draggable(entityName+entitySuffix,{
            containment : "parent"
        });
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});
$('#Add-WEntity').click(function(){
    $("#WEName")[0].value = $("#WEName")[0].value.replace(" ","_");
    if(checkInputVal($("#WEName")[0].value,allEntities) == -1) {
        var weakEntityName = $("#WEName")[0].value
            weakEntitySuffix = "-weak-entity",
            weakEntityID = "#"+weakEntityName+weakEntitySuffix;
        allEntities.push(weakEntityName);

        $("#canvas").append(createWeakEntityWithName(weakEntityName));
        $( "#WEName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        var addedEndpoint = jsPlumb.addEndpoint($(weakEntityID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            containment: weakEntityName+weakEntitySuffix,
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(weakEntityID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Rectangle"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });
        jsPlumb.draggable(weakEntityName+weakEntitySuffix,{
            containment : "parent"
        });

    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding relationships
$('#Add-RRName').click(function(){
    $("#RRName")[0].value = $("#RRName")[0].value.replace(" ","_");
    if(checkInputVal($("#RRName")[0].value,allRelationships) == -1)  {
        
        var relationshipName = $("#RRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#RRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });
        
        relationshipCounter++;
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding ISA relationships
$('#Add-ISARName').click(function(){


        
    var relationshipSuffix = "-isa-relationship",
        relationshipID = "#"+relationshipCounter+relationshipSuffix;

    allRelationships.push(relationshipID);

    $("#canvas").append(createISARelationshipWithId(relationshipID.slice(1)));
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(relationshipID), {
        endpoint : ["Image", defaultEndpointProperties],
        //anchor: ["Perimeter", { shape : "Rectangle"} ],
        anchor: "Right",
        containment: relationshipID.slice(1),
        ConnectionsDetachable:false,
        isSource: true
    });

    jsPlumb.makeTarget($(relationshipID), {
        isTarget : true,
        anchor: ["Perimeter", { shape : "Diamond"} ],
        endpoint : ["Dot", { radius : 1}],
        connector : "Straight"
    });

    jsPlumb.draggable(relationshipID.slice(1),{
        containment : "parent"
    });

    relationshipCounter++;
});

//adding ISA relationships
$('#Add-OPR').click(function(){

    var relationshipType;
    if(confirm("Press OK for UNION and CANCEL for INTERSECTION type")) {
        relationshipType = "union";
    } else {
        relationshipType = "intersection";
    }
        
    var relationshipSuffix = "-"+relationshipType+"-op-relationship",
        relationshipID = "#"+relationshipCounter+relationshipSuffix;

    allRelationships.push(relationshipID);

    $("#canvas").append(createOPRelationshipWithIdAndType(relationshipID.slice(1),relationshipType));
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(relationshipID), {
        endpoint : ["Image", defaultEndpointProperties],
        //anchor: ["Perimeter", { shape : "Rectangle"} ],
        anchor: "Right",
        containment: relationshipID.slice(1),
        ConnectionsDetachable:false,
        isSource: true
    });

    jsPlumb.makeTarget($(relationshipID), {
        isTarget : true,
        anchor: ["Perimeter", { shape : "Diamond"} ],
        endpoint : ["Dot", { radius : 1}],
        connector : "Straight"
    });

    jsPlumb.draggable(relationshipID.slice(1),{
        containment : "parent"
    });

    relationshipCounter++;
});

//adding Decomposed relationships
$('#Add-DRName').click(function(){
    $("#DRName")[0].value = $("#DRName")[0].value.replace(" ","_");
    if(checkInputVal($("#DRName")[0].value,allRelationships) == -1)  {
        
        var relationshipName = $("#DRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-dc-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createDRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#DRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

//adding Decomposed relationships
$('#Add-EXRName').click(function(){
    $("#EXRName")[0].value = $("#EXRName")[0].value.replace(" ","_");
    if(checkInputVal($("#EXRName")[0].value,allRelationships) == -1)  {
        
        var relationshipName = $("#EXRName")[0].value,
            relationshipSuffix = "-"+relationshipCounter+ "-dc-relationship",
            relationshipID = "#"+relationshipName+relationshipSuffix;

        allRelationships.push(relationshipID);
        $("#canvas").append(createEXRelationshipWithName(relationshipName,relationshipID.slice(1)));
        $( "#EXRName" )[0].value = "";
        $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

        jsPlumb.addEndpoint($(relationshipID), {
            endpoint : ["Image", defaultEndpointProperties],
            //anchor: ["Perimeter", { shape : "Rectangle"} ],
            anchor: "Right",
            containment: relationshipID.slice(1),
            ConnectionsDetachable:false,
            isSource: true
        });

        jsPlumb.makeTarget($(relationshipID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Diamond"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight"
        });

        jsPlumb.draggable(relationshipID.slice(1),{
            containment : "parent"
        });

        relationshipCounter++;
        
    } else {
        $( "#err-dialog" ).dialog();
    }
});

$( "#AttrTypeSet" ).buttonset();
$( document ).tooltip();
// Hover states on the static widgets
$( "#dialog-link, #icons li" ).hover(
    function() {
    $( this ).addClass( "ui-state-hover" );
    },
    function() {
    $( this ).removeClass( "ui-state-hover" );
    }
);
$( "#Add-Attribute-Entity" ).click(function() {
    /*var ops= ['qwerty','asdfgh'];
    $( '#tags' ).autocomplete({source: ops});
    $( "#dialog" ).dialog();*/

    var attributeName = $("#EAttrName")[0].value,
        attributeSuffix = "-attribute",
        attributeID = "#"+attributeName+attributeSuffix;

    $("#canvas").append(createAttributeWithName(attributeName));

    $( "#EAttrName" )[0].value = "";
    $( "#nestedAccordion" ).accordion({ collapsible: true, active: false});

    jsPlumb.addEndpoint($(attributeID), {
            endpoint : ["Image", defaultEndpointProperties],
            anchor: "Right",
            containment: attributeName+attributeSuffix,
            ConnectionsDetachable:false,
            isSource: true
        });

    jsPlumb.makeTarget($(attributeID), {
            isTarget : true,
            anchor: ["Perimeter", { shape : "Ellipse"} ],
            endpoint : ["Dot", { radius : 1}],
            connector : "Straight",
            maxConnections : 1
        });
    jsPlumb.draggable(attributeName+attributeSuffix,{
        containment : "parent"
    });
});




});</script>
</head>

<body>
    <div id="topheader">
    A CS4221 project by P05
    </div>
    <h1 style="color:white">Welcome to DBMod!</h1>
    <p style="color:white">Design your very own ER-diagrams and we will verify them for you!</p>
    <div id="content">
        <div id="sidebar">
            <div id="nestedAccordion">
            <h2>ADD ENTITY</h2>
            <div>
            <h3 class="subheader">Regular Entity</h3>
                <div><input type="text" name="REName" id="REName" title="Name of New Regular Entity">
                <button id="Add-REntity" class="a_button">Add it!</button></div>
            <h3 class="subheader">Weak Entity</h3>
                <div><input type="text" name="WEName" id="WEName" title="Name of New Weak Entity">
                <button id="Add-WEntity" class="a_button">Add it!</button></div>
            <h3 class="subheader">Entity Attribute</h3>
                <div><input type="text" name="EAttrName" id="EAttrName" title="Name of Attribute">
                <button id="Add-Attribute-Entity" class="a_button">Add it!</button></div>                
            </div>
            <h2>ADD RELATIONSHIP</h2>
            <div>
            <h3 class="subheader">Regular Relationship</h3>
            <div><input type="text" name="RRName" id="RRName" title="Name of New Regular Relationship">
            <button id="Add-RRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">ISA Relationship</h3>
            <div><input type="text" name="ISARName" id="ISARName" title="Name of New ISA Relationship">
            <button id="Add-ISARName" class="a_button">Add it!</button></div>
            <h3 class="subheader">OP Relationship</h3>
            <div><input type="text" name="OPRName" id="OPRName" title="Name of New OP Relationship">
            <button id="Add-OPR" class="a_button">Add it!</button></div>
            <h3 class="subheader">Decomp Relationship</h3>
            <div><input type="text" name="DRName" id="DRName" title="Name of New Decomp Relationship">
            <button id="Add-DRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">EX Relationship</h3>
            <div><input type="text" name="EXRName" id="EXRName" title="Name of New EX Relationship">
            <button id="Add-EXRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">ID Relationship</h3>
            <div><input type="text" name="IDRName" id="IDRName" title="Name of New ID Relationship">
            <button id="Add-IDRName" class="a_button">Add it!</button></div>
            <h3 class="subheader">Relationship Attribute</h3>
            <div>
            <input type="text" name="RAttrName" id="RAttrName" title="Name of Attribute">
            <p>to Entity</p>
            <input type="text" name="Link-RName" id="Link-RName"><button>Add it!</button></div>
            </div>
            <h2>DELETE</h2>
            <div>
            <h3>Entity</h3>
            <div>Which one? </div>
            </div>
            </div>
        </div>
        <div id="canvas">

        </div>
    </div>
    <div id="dialog" title="Attach to?" style="display:none;">
    <input id="tags" /><button class="a_button">Attach!</button>
    </div>
    <div id="add-entity-dialog" title="Added Entity" style="display:none;">
    </div>
    <div id="err-dialog" title="Error!" style="display:none;">
    <p>Please check your input!</p>
    </div>
</body>
</html>
